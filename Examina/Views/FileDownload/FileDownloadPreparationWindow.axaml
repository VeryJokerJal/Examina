<Window x:Class="Examina.Views.FileDownload.FileDownloadPreparationWindow" xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:views="clr-namespace:Examina.Views.FileDownload" xmlns:vm="clr-namespace:Examina.ViewModels.FileDownload" Title="文件准备" Width="800" Height="600" MinWidth="600" MinHeight="400" d:DesignHeight="600" d:DesignWidth="800" x:DataType="vm:FileDownloadPreparationViewModel" CanResize="True" Icon="/Assets/icon.ico" WindowStartupLocation="CenterScreen" mc:Ignorable="d">



    <Window.Styles>
        <!--  窗口样式  -->
        <Style Selector="Window">
            <Setter Property="Background" Value="{DynamicResource ThemeBackgroundBrush}" />
        </Style>

        <!--  标题栏样式  -->
        <Style Selector="Border.title-bar">
            <Setter Property="Background" Value="{DynamicResource ThemeAccentBrush}" />
            <Setter Property="Padding" Value="20,16" />
        </Style>

        <!--  玻璃拟态卡片样式  -->
        <Style Selector="Border.glass-card">
            <Setter Property="Background" Value="{DynamicResource ThemeCardBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource ThemeBorderMidBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="12" />
        </Style>

        <!--  按钮样式  -->
        <Style Selector="Button.glass-button">
            <Setter Property="Background" Value="{DynamicResource ThemeAccentBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource ThemeAccentBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Margin" Value="6" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="MinWidth" Value="100" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <Style Selector="Button.glass-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource ThemeAccentBrush2}" />
        </Style>

        <Style Selector="Button.glass-button:pressed">
            <Setter Property="Background" Value="{DynamicResource ThemeAccentBrush3}" />
        </Style>

        <!--  危险按钮样式  -->
        <Style Selector="Button.glass-button.danger">
            <Setter Property="Background" Value="#DC3545" />
            <Setter Property="BorderBrush" Value="#DC3545" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <!--  成功按钮样式  -->
        <Style Selector="Button.glass-button.success">
            <Setter Property="Background" Value="#28A745" />
            <Setter Property="BorderBrush" Value="#28A745" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <!--  进度条样式  -->
        <Style Selector="ProgressBar.glass-progress">
            <Setter Property="Background" Value="{DynamicResource ThemeControlMidBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource ThemeBorderMidBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Height" Value="12" />
        </Style>

        <!--  状态指示器样式  -->
        <Style Selector="Border.status-indicator">
            <Setter Property="Width" Value="16" />
            <Setter Property="Height" Value="16" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,0,12,0" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Pending]">
            <Setter Property="Background" Value="#6C757D" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Downloading]">
            <Setter Property="Background" Value="#FFC107" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Downloaded]">
            <Setter Property="Background" Value="#28A745" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Extracting]">
            <Setter Property="Background" Value="#17A2B8" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Completed]">
            <Setter Property="Background" Value="#28A745" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Failed]">
            <Setter Property="Background" Value="#DC3545" />
        </Style>

        <Style Selector="Border.status-indicator[Tag=Cancelled]">
            <Setter Property="Background" Value="#DC3545" />
        </Style>

        <!--  错误消息样式  -->
        <Style Selector="Border.error-message">
            <Setter Property="Background" Value="#F8D7DA" />
            <Setter Property="BorderBrush" Value="#DC3545" />
        </Style>

        <Style Selector="TextBlock.error-text">
            <Setter Property="Foreground" Value="#DC3545" />
        </Style>

        <!--  成功消息样式  -->
        <Style Selector="Border.success-message">
            <Setter Property="Background" Value="#D4EDDA" />
            <Setter Property="BorderBrush" Value="#28A745" />
        </Style>

        <Style Selector="TextBlock.success-text">
            <Setter Property="Foreground" Value="#28A745" />
        </Style>

        <!--  错误计数样式  -->
        <Style Selector="Run.error-count">
            <Setter Property="Foreground" Value="#DC3545" />
        </Style>

        <!--  深色模式样式覆盖  -->
        <Style Selector=":is(Window)[((FluentAvalonia|Styling|FluentAvaloniaTheme)RequestedTheme)=Dark] Border.error-message">
            <Setter Property="Background" Value="#2D1B1E" />
            <Setter Property="BorderBrush" Value="#F87171" />
        </Style>

        <Style Selector=":is(Window)[((FluentAvalonia|Styling|FluentAvaloniaTheme)RequestedTheme)=Dark] TextBlock.error-text">
            <Setter Property="Foreground" Value="#F87171" />
        </Style>

        <Style Selector=":is(Window)[((FluentAvalonia|Styling|FluentAvaloniaTheme)RequestedTheme)=Dark] Border.success-message">
            <Setter Property="Background" Value="#1A2E1A" />
            <Setter Property="BorderBrush" Value="#4ADE80" />
        </Style>

        <Style Selector=":is(Window)[((FluentAvalonia|Styling|FluentAvaloniaTheme)RequestedTheme)=Dark] TextBlock.success-text">
            <Setter Property="Foreground" Value="#4ADE80" />
        </Style>

        <!--  深色模式下的失败文件计数  -->
        <Style Selector=":is(Window)[((FluentAvalonia|Styling|FluentAvaloniaTheme)RequestedTheme)=Dark] Run.error-count">
            <Setter Property="Foreground" Value="#F87171" />
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="Auto,*,Auto">
        <!--  标题栏  -->
        <Border Grid.Row="0" Classes="title-bar">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <TextBlock Margin="0,0,0,4" FontSize="24" FontWeight="SemiBold" Foreground="White" Text="{Binding TaskName}" />
                    <TextBlock FontSize="16" Foreground="White" Opacity="0.9" Text="考试/训练" />
                </StackPanel>

                <StackPanel Grid.Column="1" VerticalAlignment="Center" Orientation="Horizontal">
                    <TextBlock FontSize="20" FontWeight="Bold" Foreground="White" Text="{Binding CompletedFileCount}" />
                    <TextBlock FontSize="20" Foreground="White" Text=" / " />
                    <TextBlock FontSize="20" FontWeight="Bold" Foreground="White" Text="{Binding TotalFileCount}" />
                    <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" FontSize="16" Foreground="White" Text=" 文件" />
                </StackPanel>
            </Grid>
        </Border>

        <!--  主要内容区域  -->
        <ScrollViewer Grid.Row="1" Padding="0,12">
            <StackPanel Spacing="0">
                <!--  整体进度卡片  -->
                <Border Classes="glass-card">
                    <StackPanel Spacing="16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" FontSize="18" FontWeight="Medium" Text="{Binding StatusMessage}" />
                            <TextBlock Grid.Column="1" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource ThemeAccentBrush}" Text="{Binding OverallProgress, StringFormat='{}{0:F1}%'}" />
                        </Grid>

                        <ProgressBar Classes="glass-progress" Maximum="100" Value="{Binding OverallProgress}" />

                        <!--  错误消息  -->
                        <Border Padding="16,12" Classes="error-message" BorderThickness="1" CornerRadius="8" IsVisible="{Binding HasError}">
                            <StackPanel Spacing="8">
                                <TextBlock FontWeight="Medium" Classes="error-text" Text="❌ 下载过程中出现错误" />
                                <TextBlock Classes="error-text" Text="{Binding ErrorMessage}" TextWrapping="Wrap" />
                            </StackPanel>
                        </Border>

                        <!--  成功消息  -->
                        <Border Padding="16,12" Classes="success-message" BorderThickness="1" CornerRadius="8" IsVisible="{Binding IsCompleted}">
                            <TextBlock FontWeight="Medium" Classes="success-text" Text="✅ 所有文件下载完成，可以开始考试/训练" />
                        </Border>
                    </StackPanel>
                </Border>

                <!--  文件列表卡片  -->
                <Border Classes="glass-card">
                    <StackPanel Spacing="16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" FontSize="18" FontWeight="Medium" Text="文件下载详情" />
                            <ToggleButton Grid.Column="1" Content="显示详细进度" IsChecked="{Binding ShowDetails}" />
                        </Grid>

                        <ItemsControl ItemsSource="{Binding Files}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,6" Padding="16" Background="{DynamicResource ThemeControlLowBrush}" BorderBrush="{DynamicResource ThemeBorderMidBrush}" BorderThickness="1" CornerRadius="8">
                                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                                            <!--  状态指示器  -->
                                            <Border Grid.Row="0" Grid.Column="0" VerticalAlignment="Center"
                                                    Width="12" Height="12" CornerRadius="6" Margin="0,0,12,0"
                                                    Tag="{Binding Status}"
                                                    Classes="status-indicator">
                                            </Border>

                                            <!--  文件信息  -->
                                            <StackPanel Grid.Row="0" Grid.Column="1" Spacing="6">
                                                <TextBlock FontSize="14" FontWeight="Medium" Text="{Binding FileName}" />
                                                <TextBlock FontSize="12" Opacity="0.7" Text="{Binding StatusMessage}" />
                                            </StackPanel>

                                            <!--  进度和大小  -->
                                            <StackPanel Grid.Row="0" Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center" Orientation="Vertical">
                                                <TextBlock HorizontalAlignment="Right" FontSize="14" FontWeight="Medium" Text="{Binding Progress, StringFormat='{}{0:F1}%'}" />
                                                <TextBlock HorizontalAlignment="Right" FontSize="12" Opacity="0.7" Text="{Binding FormattedTotalSize}" />
                                            </StackPanel>

                                            <!--  详细进度条  -->
                                            <ProgressBar Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Margin="0,12,0,0" Classes="glass-progress" IsVisible="{Binding $parent[Window].((vm:FileDownloadPreparationViewModel)DataContext).ShowDetails}" Maximum="100" Value="{Binding Progress}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!--  操作按钮栏  -->
        <Border Grid.Row="2" Padding="20,16" Background="{DynamicResource ThemeControlLowBrush}" BorderBrush="{DynamicResource ThemeBorderMidBrush}" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto">
                <!--  状态信息  -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center" Orientation="Horizontal" Spacing="20">
                    <TextBlock IsVisible="{Binding HasError}">
                        <Run Text="❌" />
                        <Run FontWeight="Medium" Classes="error-count" Text="{Binding FailedFileCount}" />
                        <Run Text="个文件失败" />
                    </TextBlock>
                </StackPanel>

                <!--  操作按钮  -->
                <Button Grid.Column="1" Classes="glass-button success" Command="{Binding StartDownloadCommand}" Content="开始下载" IsVisible="{Binding CanStartDownload}" />

                <Button Grid.Column="2" Classes="glass-button danger" Command="{Binding CancelDownloadCommand}" Content="取消下载" IsVisible="{Binding CanCancelDownload}" />

                <Button Grid.Column="3" Classes="glass-button" Command="{Binding RetryDownloadCommand}" Content="重试下载" IsVisible="{Binding CanRetryDownload}" />

                <Button Grid.Column="4" Classes="glass-button" Click="OnCloseClick" Command="{Binding CloseCommand}" Content="关闭" />
            </Grid>
        </Border>
    </Grid>
</Window>
