<UserControl x:Class="Examina.Views.Pages.LeaderboardView" xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:converters="using:Examina.Converters" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:vm="clr-namespace:Examina.ViewModels.Pages" d:DesignHeight="600" d:DesignWidth="800" x:DataType="vm:LeaderboardViewModel" mc:Ignorable="d">

    <UserControl.Resources>
        <converters:DebugMultiValueConverter x:Key="DebugConverter" />
        <converters:TrainingButtonTextConverter x:Key="ButtonTextConverter" />
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,*">
        <!--  标题栏  -->
        <Border Grid.Row="0" Padding="20,15" Background="{DynamicResource SystemAccentColor}">
            <StackPanel Orientation="Horizontal">
                <TextBlock VerticalAlignment="Center" FontSize="20" FontWeight="Bold" Foreground="White" Text="{Binding PageTitle}" />
            </StackPanel>
        </Border>

        <!--  筛选和排序栏  -->
        <Border Grid.Row="1" Padding="20,15" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
            <Grid RowDefinitions="Auto,Auto">
                <!--  第一行：排行榜类型和试卷筛选  -->
                <Grid Grid.Row="0" Margin="0,0,0,10" ColumnDefinitions="Auto,*,Auto,*,Auto">
                    <!--  排行榜类型选择  -->
                    <TextBlock Grid.Column="0" Margin="0,0,10,0" VerticalAlignment="Center" Text="排行榜类型:" />
                    <ComboBox Grid.Column="1" MinWidth="200" Margin="0,0,20,0" DisplayMemberBinding="{Binding Name}" ItemsSource="{Binding LeaderboardTypes}" SelectedItem="{Binding SelectedLeaderboardType}" />

                    <!--  试卷筛选器  -->
                    <TextBlock Grid.Column="2" Margin="0,0,10,0" VerticalAlignment="Center" IsVisible="{Binding ShowExamFilter}" Text="试卷筛选:" />
                    <ComboBox Grid.Column="3" MinWidth="150" Margin="0,0,20,0" DisplayMemberBinding="{Binding DisplayName}" IsVisible="{Binding ShowExamFilter}" ItemsSource="{Binding ExamFilters}" SelectedItem="{Binding SelectedExamFilter}" />

                    <!--  刷新按钮  -->
                    <Button Grid.Column="4" Classes="accent" Command="{Binding RefreshLeaderboardCommand}" Content="刷新" />
                </Grid>

                <!--  第二行：排序选项  -->
                <Grid Grid.Row="1" ColumnDefinitions="Auto,*">
                    <TextBlock Grid.Column="0" Margin="0,0,10,0" VerticalAlignment="Center" Text="排序方式:" />
                    <ItemsControl Grid.Column="1" ItemsSource="{Binding SortOptions}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="10" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <RadioButton Command="{Binding $parent[UserControl].((vm:LeaderboardViewModel)DataContext).SortCommand}" CommandParameter="{Binding Value}" Content="{Binding DisplayText}" IsChecked="{Binding IsSelected}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </Grid>
        </Border>

        <!--  主内容区域  -->
        <ScrollViewer Grid.Row="2" Padding="20">
            <StackPanel Spacing="15">
                <!--  排行榜数据  -->
                <Border MinHeight="400" Padding="20" Background="{DynamicResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" IsVisible="{Binding !IsLoading}">
                    <DataGrid GridLinesVisibility="Horizontal" HeadersVisibility="Column" IsReadOnly="True" ItemsSource="{Binding LeaderboardData}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Width="80" Binding="{Binding Rank}" Header="排名" />
                            <DataGridTextColumn Width="150" Binding="{Binding Username}" Header="用户名" />
                            <DataGridTextColumn Width="120" Binding="{Binding SchoolName}" Header="学校" />
                            <DataGridTextColumn Width="100" Binding="{Binding ClassName}" Header="班级" />
                            <DataGridTextColumn Width="100" Binding="{Binding Score}" Header="分数" />
                            <DataGridTextColumn Width="120" Binding="{Binding CompletionTime, StringFormat='{}{0:hh\\:mm\\:ss}'}" Header="用时" />
                            <DataGridTextColumn Width="180" Binding="{Binding CompletionDate, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" Header="完成时间" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>

                <!--  加载状态  -->
                <Border Padding="40" HorizontalAlignment="Center" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" CornerRadius="5" IsVisible="{Binding IsLoading}">
                    <StackPanel HorizontalAlignment="Center" Spacing="10">
                        <ProgressBar Width="200" IsIndeterminate="True" />
                        <TextBlock HorizontalAlignment="Center" FontSize="14" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Text="正在加载排行榜数据..." />
                    </StackPanel>
                </Border>

                <!--  错误状态  -->
                <Border Padding="40" HorizontalAlignment="Center" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" CornerRadius="5">
                    <Border.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                            <Binding Path="!IsLoading" />
                            <Binding Converter="{x:Static StringConverters.IsNotNullOrEmpty}" Path="ErrorMessage" />
                        </MultiBinding>
                    </Border.IsVisible>
                    <StackPanel HorizontalAlignment="Center" Spacing="10">
                        <TextBlock HorizontalAlignment="Center" FontSize="48" Opacity="0.5" Text="❌" />
                        <TextBlock HorizontalAlignment="Center" FontSize="16" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Text="加载失败" />
                        <TextBlock HorizontalAlignment="Center" FontSize="14" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Text="{Binding ErrorMessage}" TextWrapping="Wrap" />
                        <Button Classes="accent" Command="{Binding RefreshLeaderboardCommand}" Content="重试" />
                    </StackPanel>
                </Border>

                <!--  空状态  -->
                <Border Padding="40" HorizontalAlignment="Center" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" CornerRadius="5">
                    <Border.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                            <Binding Path="!IsLoading" />
                            <Binding Converter="{x:Static StringConverters.IsNullOrEmpty}" Path="ErrorMessage" />
                            <Binding Converter="{x:Static ObjectConverters.Equal}" ConverterParameter="0" Path="LeaderboardData.Count" />
                        </MultiBinding>
                    </Border.IsVisible>
                    <StackPanel HorizontalAlignment="Center" Spacing="10">
                        <TextBlock HorizontalAlignment="Center" FontSize="48" Opacity="0.5" Text="📊" />
                        <TextBlock HorizontalAlignment="Center" FontSize="16" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Text="暂无排行榜数据" />
                        <TextBlock HorizontalAlignment="Center" FontSize="14" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Text="当前还没有完成的考试或训练记录" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
