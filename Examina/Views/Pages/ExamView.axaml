<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Examina.ViewModels.Pages"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="Examina.Views.Pages.ExamView"
             x:DataType="vm:ExamViewModel">

  <UserControl.Resources>
    <!-- å†…ç½®è½¬æ¢å™¨ -->
    <x:Static x:Key="StringConverters.IsNotNullOrEmpty" Member="StringConverters.IsNotNullOrEmpty"/>
    <x:Static x:Key="ObjectConverters.IsNotNull" Member="ObjectConverters.IsNotNull"/>
    <x:Static x:Key="IntConverters.IsGreaterThan" Member="IntConverters.IsGreaterThan"/>
  </UserControl.Resources>

  <ScrollViewer>
    <StackPanel Margin="24" Spacing="24">
      
      <!-- é¡µé¢æ ‡é¢˜ -->
      <TextBlock Text="{Binding PageTitle}" 
                 FontSize="28" 
                 FontWeight="Bold"
                 FontFamily="Microsoft YaHei"
                 Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
      
      <!-- è€ƒè¯•é€‰æ‹©å¡ç‰‡ -->
      <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
              CornerRadius="12"
              Padding="24">
        <StackPanel Spacing="16">

          <!-- è€ƒè¯•é€‰æ‹©æ ‡é¢˜ -->
          <StackPanel Orientation="Horizontal" Spacing="12">
            <TextBlock Text="ðŸ“" FontSize="32"/>
            <StackPanel VerticalAlignment="Center">
              <TextBlock Text="é€‰æ‹©è€ƒè¯•"
                         FontSize="20"
                         FontWeight="SemiBold"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
              <TextBlock Text="è¯·é€‰æ‹©è¦å‚åŠ çš„è€ƒè¯•"
                         FontSize="14"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            </StackPanel>
          </StackPanel>

          <!-- è€ƒè¯•åˆ—è¡¨ -->
          <ComboBox ItemsSource="{Binding AvailableExams}"
                    SelectedItem="{Binding SelectedExam}"
                    DisplayMemberBinding="{Binding Name}"
                    PlaceholderText="è¯·é€‰æ‹©è€ƒè¯•"
                    FontFamily="Microsoft YaHei"
                    MinWidth="300"/>

          <!-- è€ƒè¯•æ¬¡æ•°é™åˆ¶ä¿¡æ¯ -->
          <StackPanel IsVisible="{Binding SelectedExam, Converter={x:Static ObjectConverters.IsNotNull}}"
                      Spacing="12">
            <Separator/>

            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>

              <StackPanel Grid.Column="0">
                <TextBlock Text="è€ƒè¯•çŠ¶æ€"
                           FontSize="12"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                <TextBlock Text="{Binding ExamStatusDescription}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"
                           Margin="0,4,0,0"/>
              </StackPanel>

              <StackPanel Grid.Column="1">
                <TextBlock Text="æ¬¡æ•°ç»Ÿè®¡"
                           FontSize="12"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                <TextBlock Text="{Binding AttemptCountDescription}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemAccentColor}"
                           Margin="0,4,0,0"/>
              </StackPanel>
            </Grid>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- è€ƒè¯•çŠ¶æ€å¡ç‰‡ -->
      <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
              CornerRadius="12"
              Padding="24">
        <StackPanel Spacing="16">

          <!-- è€ƒè¯•çŠ¶æ€å›¾æ ‡å’Œæ ‡é¢˜ -->
          <StackPanel Orientation="Horizontal" Spacing="12">
            <TextBlock Text="ðŸ“‹" FontSize="32"/>
            <StackPanel VerticalAlignment="Center">
              <TextBlock Text="è€ƒè¯•çŠ¶æ€"
                         FontSize="20"
                         FontWeight="SemiBold"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
              <TextBlock Text="{Binding ExamStatus}"
                         FontSize="14"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            </StackPanel>
          </StackPanel>
          
          <!-- è€ƒè¯•ä¿¡æ¯ï¼ˆå½“æœ‰æ­£åœ¨è¿›è¡Œçš„è€ƒè¯•æ—¶æ˜¾ç¤ºï¼‰ -->
          <StackPanel IsVisible="{Binding HasActiveExam}" Spacing="12">
            <Separator/>
            
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>
              
              <StackPanel Grid.Column="0">
                <TextBlock Text="è€ƒè¯•åç§°" 
                           FontSize="12"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                <TextBlock Text="{Binding ExamName}" 
                           FontSize="16" 
                           FontWeight="SemiBold"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"
                           Margin="0,4,0,0"/>
              </StackPanel>
              
              <StackPanel Grid.Column="1">
                <TextBlock Text="å‰©ä½™æ—¶é—´" 
                           FontSize="12"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                <TextBlock Text="{Binding RemainingTime}" 
                           FontSize="16" 
                           FontWeight="SemiBold"
                           FontFamily="Microsoft YaHei"
                           Foreground="{DynamicResource SystemAccentColor}"
                           Margin="0,4,0,0"/>
              </StackPanel>
            </Grid>
          </StackPanel>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <StackPanel Spacing="12">
            <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
            <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
              <Button Content="{Binding StartExamButtonText}"
                      Classes="accent"
                      Command="{Binding StartExamCommand}"
                      IsVisible="{Binding !HasActiveExam}"
                      IsEnabled="{Binding SelectedExam, Converter={x:Static ObjectConverters.IsNotNull}}"
                      Padding="20,10"
                      FontFamily="Microsoft YaHei"/>

              <Button Content="ç»§ç»­è€ƒè¯•"
                      Classes="accent"
                      Command="{Binding ContinueExamCommand}"
                      IsVisible="{Binding HasActiveExam}"
                      Padding="20,10"
                      FontFamily="Microsoft YaHei"/>

              <Button Content="åˆ·æ–°çŠ¶æ€"
                      Command="{Binding RefreshExamStatusCommand}"
                      Padding="20,10"
                      FontFamily="Microsoft YaHei"/>
            </StackPanel>

            <!-- é‡è€ƒå’Œç»ƒä¹ æŒ‰é’® -->
            <StackPanel Orientation="Horizontal"
                        Spacing="12"
                        HorizontalAlignment="Center"
                        IsVisible="{Binding SelectedExam, Converter={x:Static ObjectConverters.IsNotNull}}">
              <Button Content="{Binding RetakeButtonText}"
                      Classes="secondary"
                      Command="{Binding RetakeExamCommand}"
                      IsVisible="{Binding CanRetake}"
                      Padding="16,8"
                      FontFamily="Microsoft YaHei"/>

              <Button Content="é‡åšç»ƒä¹ "
                      Classes="secondary"
                      Command="{Binding PracticeExamCommand}"
                      IsVisible="{Binding CanPractice}"
                      Padding="16,8"
                      FontFamily="Microsoft YaHei"/>

              <Button Content="æŸ¥çœ‹åŽ†å²"
                      Command="{Binding ViewExamHistoryCommand}"
                      Padding="16,8"
                      FontFamily="Microsoft YaHei"/>
            </StackPanel>
          </StackPanel>

          <!-- é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º -->
          <Border Background="{DynamicResource SystemControlBackgroundAccentBrush}"
                  CornerRadius="6"
                  Padding="15,10"
                  Margin="0,10,0,0"
                  IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="âš ï¸" FontSize="16" VerticalAlignment="Center"/>
              <TextBlock Text="{Binding ErrorMessage}"
                         FontSize="14"
                         FontFamily="Microsoft YaHei"
                         Foreground="White"
                         TextWrapping="Wrap"
                         VerticalAlignment="Center"/>
            </StackPanel>
          </Border>
        </StackPanel>
      </Border>

      <!-- è€ƒè¯•åŽ†å²è®°å½• -->
      <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
              CornerRadius="12"
              Padding="24"
              IsVisible="{Binding ExamAttemptHistory.Count, Converter={x:Static IntConverters.IsGreaterThan}, ConverterParameter=0}">
        <StackPanel Spacing="16">

          <!-- åŽ†å²è®°å½•æ ‡é¢˜ -->
          <StackPanel Orientation="Horizontal" Spacing="12">
            <TextBlock Text="ðŸ“Š" FontSize="32"/>
            <StackPanel VerticalAlignment="Center">
              <TextBlock Text="è€ƒè¯•åŽ†å²"
                         FontSize="20"
                         FontWeight="SemiBold"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
              <TextBlock Text="{Binding ExamAttemptHistory.Count, StringFormat='å…± {0} æ¬¡è€ƒè¯•è®°å½•'}"
                         FontSize="14"
                         FontFamily="Microsoft YaHei"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            </StackPanel>
          </StackPanel>

          <!-- åŽ†å²è®°å½•åˆ—è¡¨ -->
          <ScrollViewer MaxHeight="300">
            <ItemsControl ItemsSource="{Binding ExamAttemptHistory}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                          CornerRadius="8"
                          Padding="16"
                          Margin="0,0,0,8">
                    <Grid>
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                      </Grid.ColumnDefinitions>

                      <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding AttemptTypeDisplay}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                        <TextBlock Text="{Binding StartedAt, StringFormat='å¼€å§‹æ—¶é—´: {0:yyyy-MM-dd HH:mm}'}"
                                   FontSize="12"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                      </StackPanel>

                      <StackPanel Grid.Column="1" Margin="16,0">
                        <TextBlock Text="{Binding StatusDisplay}"
                                   FontSize="12"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        <TextBlock Text="{Binding ScorePercentageDisplay}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemAccentColor}"/>
                      </StackPanel>

                      <StackPanel Grid.Column="2" Margin="16,0">
                        <TextBlock Text="ç”¨æ—¶"
                                   FontSize="12"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        <TextBlock Text="{Binding DurationDisplay}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                      </StackPanel>

                      <Border Grid.Column="3"
                              Background="{DynamicResource SystemAccentColor}"
                              CornerRadius="12"
                              Padding="8,4"
                              IsVisible="{Binding IsRanked}">
                        <TextBlock Text="è®¡åˆ†"
                                   FontSize="10"
                                   FontFamily="Microsoft YaHei"
                                   Foreground="White"
                                   HorizontalAlignment="Center"/>
                      </Border>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </StackPanel>
      </Border>

      <!-- è€ƒè¯•è¯´æ˜Ž -->
      <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
              CornerRadius="8"
              Padding="20">
        <StackPanel Spacing="12">
          <TextBlock Text="è€ƒè¯•è¯´æ˜Ž" 
                     FontSize="18" 
                     FontWeight="SemiBold"
                     FontFamily="Microsoft YaHei"
                     Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
          
          <StackPanel Spacing="8">
            <TextBlock Text="â€¢ è¯·ç¡®ä¿ç½‘ç»œè¿žæŽ¥ç¨³å®šï¼Œé¿å…è€ƒè¯•è¿‡ç¨‹ä¸­æ–­ç½‘" 
                       FontSize="14"
                       FontFamily="Microsoft YaHei"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <TextBlock Text="â€¢ è€ƒè¯•è¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­åº”ç”¨ç¨‹åºæˆ–åˆ‡æ¢åˆ°å…¶ä»–ç¨‹åº" 
                       FontSize="14"
                       FontFamily="Microsoft YaHei"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <TextBlock Text="â€¢ è€ƒè¯•æ—¶é—´åˆ°åŽç³»ç»Ÿå°†è‡ªåŠ¨æäº¤ç­”æ¡ˆ" 
                       FontSize="14"
                       FontFamily="Microsoft YaHei"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <TextBlock Text="â€¢ å¦‚é‡æŠ€æœ¯é—®é¢˜è¯·åŠæ—¶è”ç³»ç›‘è€ƒè€å¸ˆ" 
                       FontSize="14"
                       FontFamily="Microsoft YaHei"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
          </StackPanel>
        </StackPanel>
      </Border>
      
    </StackPanel>
  </ScrollViewer>
</UserControl>
