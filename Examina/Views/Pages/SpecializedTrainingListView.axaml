<UserControl x:Class="Examina.Views.Pages.SpecializedTrainingListView" xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:models="using:Examina.Models.SpecializedTraining" xmlns:vm="using:Examina.ViewModels.Pages" xmlns:converters="using:Examina.Converters" d:DesignHeight="450" d:DesignWidth="800" x:DataType="vm:SpecializedTrainingListViewModel" mc:Ignorable="d">

    <UserControl.Resources>
        <converters:DebugMultiValueConverter x:Key="DebugConverter" />
        <converters:TrainingButtonTextConverter x:Key="ButtonTextConverter" />
        <converters:TrainingButtonEnabledConverter x:Key="ButtonEnabledConverter" />
    </UserControl.Resources>

    <Design.DataContext>
        <vm:SpecializedTrainingListViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!--  标题栏  -->
        <Border Grid.Row="0" Padding="20,15" Background="{DynamicResource SystemAccentColor}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Margin="0,0,10,0" VerticalAlignment="Center" FontSize="24" Text="🎯" />
                <TextBlock VerticalAlignment="Center" FontSize="20" FontWeight="Bold" Foreground="White" Text="专项训练" />
                <TextBlock Margin="20,0,0,0" VerticalAlignment="Center" FontSize="14" Foreground="White" Opacity="0.8" Text="{Binding TotalCount, StringFormat={}共 {0} 个训练项目}" />
            </StackPanel>
        </Border>

        <!--  搜索和筛选栏  -->
        <Border Grid.Row="1" Padding="20,15" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                <!--  搜索框  -->
                <TextBox Grid.Column="0" Margin="0,0,10,0" Text="{Binding SearchKeyword}" Watermark="搜索专项训练..." />

                <!--  模块类型筛选  -->
                <ComboBox Grid.Column="1" MinWidth="120" Margin="0,0,10,0" ItemsSource="{Binding ModuleTypes}" PlaceholderText="选择模块类型" SelectedItem="{Binding SelectedModuleType}" />

                <!--  搜索按钮  -->
                <Button Grid.Column="2" Margin="0,0,10,0" Classes="accent" Command="{Binding SearchCommand}" Content="搜索" />

                <!--  清除筛选按钮  -->
                <Button Grid.Column="3" Margin="0,0,0,0" Command="{Binding ClearFilterCommand}" Content="清除" />
            </Grid>
        </Border>

        <!--  主内容区域  -->
        <ScrollViewer Grid.Row="2" Padding="20">
            <StackPanel Spacing="15">
                <!--  错误消息  -->
                <Border Padding="15" Background="#FFEBEE" BorderBrush="#F44336" BorderThickness="1" CornerRadius="5" IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,10,0" VerticalAlignment="Center" FontSize="16" Text="⚠️" />
                        <TextBlock VerticalAlignment="Center" Foreground="#D32F2F" Text="{Binding ErrorMessage}" />
                    </StackPanel>
                </Border>

                <!--  加载指示器  -->
                <Border Padding="20" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" CornerRadius="5" IsVisible="{Binding IsLoading}">
                    <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                        <TextBlock Margin="0,0,10,0" VerticalAlignment="Center" FontSize="16" Text="🔄" />
                        <TextBlock VerticalAlignment="Center" Text="正在加载专项训练列表..." />
                    </StackPanel>
                </Border>

                <!--  空状态显示  -->
                <Border Padding="40" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" CornerRadius="8" IsVisible="{Binding ShowEmptyState}">
                    <StackPanel HorizontalAlignment="Center" Spacing="15">
                        <TextBlock HorizontalAlignment="Center" FontSize="48" Text="📚" />
                        <TextBlock HorizontalAlignment="Center" FontSize="18" FontWeight="SemiBold" Text="暂无专项训练" />
                        <TextBlock HorizontalAlignment="Center" FontSize="14" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="请尝试调整搜索条件或联系管理员添加专项训练内容" TextWrapping="Wrap" />
                        <Button Margin="0,10,0,0" HorizontalAlignment="Center" Classes="accent" Command="{Binding RefreshCommand}" Content="刷新" />
                    </StackPanel>
                </Border>

                <!--  专项训练列表  -->
                <ItemsControl IsVisible="{Binding HasTrainings}" ItemsSource="{Binding Trainings}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:StudentSpecializedTrainingDto">
                            <Border Margin="0,0,0,10" Padding="20" Background="Transparent" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="8">
                                <Border.Styles>
                                    <Style Selector="Border:pointerover">
                                        <Setter Property="Background" Value="{DynamicResource LayerFillColorAltBrush}" />
                                        <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}" />
                                    </Style>
                                </Border.Styles>

                                <Grid ColumnDefinitions="*,Auto">
                                    <!--  训练信息  -->
                                    <StackPanel Grid.Column="0" Spacing="8">
                                        <!--  训练名称和模块类型  -->
                                        <StackPanel Orientation="Horizontal" Spacing="10">
                                            <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding Name}" />
                                            <Border Padding="6,2" Background="{DynamicResource SystemAccentColor}" CornerRadius="3">
                                                <TextBlock VerticalAlignment="Center" FontSize="12" Foreground="White" Text="{Binding ModuleType}" />
                                            </Border>
                                        </StackPanel>

                                        <!--  训练描述  -->
                                        <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}" IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" Text="{Binding Description}" TextWrapping="Wrap" />

                                        <!--  训练详情  -->
                                        <StackPanel Orientation="Horizontal" Spacing="20">
                                            <StackPanel Orientation="Horizontal" Spacing="5">
                                                <TextBlock FontSize="14" Text="📊" />
                                                <TextBlock FontSize="14" Text="{Binding TotalScore, StringFormat={}{0} 分}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <!--  标签  -->
                                        <ItemsControl IsVisible="{Binding TagList.Count, Converter={x:Static ObjectConverters.IsNotNull}}" ItemsSource="{Binding TagList}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal" />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,0,5,2" Padding="4,2" Background="{DynamicResource SystemControlBackgroundBaseLowBrush}" CornerRadius="3">
                                                        <TextBlock FontSize="11" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="{Binding}" />
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>


                                    </StackPanel>

                                    <!--  操作按钮  -->
                                    <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10">
                                        <Button MinWidth="100" Padding="15,8" Classes="accent"
                                                Command="{Binding $parent[UserControl].((vm:SpecializedTrainingListViewModel)DataContext).StartTrainingCommand}"
                                                CommandParameter="{Binding}">
                                            <Button.Content>
                                                <MultiBinding Converter="{StaticResource ButtonTextConverter}">
                                                    <Binding Path="$parent[UserControl].((vm:SpecializedTrainingListViewModel)DataContext).HasFullAccess" />
                                                    <Binding Path="EnableTrial" />
                                                </MultiBinding>
                                            </Button.Content>
                                            <Button.IsEnabled>
                                                <MultiBinding Converter="{StaticResource ButtonEnabledConverter}">
                                                    <Binding Path="$parent[UserControl].((vm:SpecializedTrainingListViewModel)DataContext).HasFullAccess" />
                                                    <Binding Path="EnableTrial" />
                                                </MultiBinding>
                                            </Button.IsEnabled>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!--  底部操作栏  -->
        <Border Grid.Row="3" Padding="20,15" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <!--  状态信息  -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center" Orientation="Horizontal" Spacing="10">
                    <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="{Binding Trainings.Count, StringFormat={}已显示 {0} 项}" />
                    <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="{Binding TotalCount, StringFormat={}共 {0} 项}" />
                </StackPanel>

                <!--  刷新按钮  -->
                <Button Grid.Column="1" Margin="0,0,10,0" Command="{Binding RefreshCommand}" Content="刷新" />

                <!--  加载更多按钮  -->
                <Button Grid.Column="2" Command="{Binding LoadMoreCommand}" Content="加载更多" IsVisible="{Binding HasMoreData}" />
            </Grid>
        </Border>
    </Grid>
</UserControl>
