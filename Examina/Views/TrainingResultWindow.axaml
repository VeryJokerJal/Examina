<Window
    x:Class="Examina.Views.TrainingResultWindow"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Examina.ViewModels"
    xmlns:conv="using:Examina.Converters"
    Title="{Binding Title}"
    Width="1000"
    Height="800"
    d:DesignHeight="800"
    d:DesignWidth="1000"
    x:DataType="vm:TrainingResultViewModel"
    Icon="/Assets/icon.ico"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.Styles>
        <Style Selector="TextBlock.header">
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>
        <Style Selector="TextBlock.subheader">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>
        <Style Selector="TextBlock.content">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Margin" Value="0,2" />
        </Style>
        <Style Selector="Border.section">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefault}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefault}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>
        <Style Selector="Border.score-card">
            <Setter Property="Background" Value="{DynamicResource AccentFillColorDefault}" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Margin" Value="8" />
        </Style>
        <Style Selector="Border.module-item">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefault}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefault}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>
        <Style Selector="Border.question-item">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefault}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefault}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>
    </Window.Styles>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock
                Classes="header"
                FontSize="24"
                Text="{Binding Title}" />
            <TextBlock
                FontSize="16"
                Foreground="{DynamicResource TextFillColorSecondary}"
                Text="{Binding TrainingName}" />
        </StackPanel>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- æˆç»©æ¦‚è§ˆ -->
                <Border Classes="section">
                    <StackPanel>
                        <TextBlock Classes="header" Text="æˆç»©æ¦‚è§ˆ" />
                        
                        <!-- åˆ†æ•°å¡ç‰‡ -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- æ€»åˆ† -->
                            <Border Grid.Column="0" Classes="score-card">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock
                                        FontSize="24"
                                        FontWeight="Bold"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="{Binding AchievedScore, StringFormat={}{0:F1}}" />
                                    <TextBlock
                                        FontSize="12"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="{Binding TotalScore, StringFormat={}æ€»åˆ†: {0:F1}}" />
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="å¾—åˆ†" />
                                </StackPanel>
                            </Border>
                            
                            <!-- å¾—åˆ†çŽ‡ -->
                            <Border Grid.Column="1" Classes="score-card">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock
                                        FontSize="24"
                                        FontWeight="Bold"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="{Binding ScoreRate, StringFormat={}{0:F1}%}" />
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="å¾—åˆ†çŽ‡" />
                                </StackPanel>
                            </Border>
                            
                            <!-- æ­£ç¡®çŽ‡ -->
                            <Border Grid.Column="2" Classes="score-card">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock
                                        FontSize="24"
                                        FontWeight="Bold"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="{Binding CorrectRate, StringFormat={}{0:F1}%}" />
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="æ­£ç¡®çŽ‡" />
                                </StackPanel>
                            </Border>
                            
                            <!-- æˆç»©ç­‰çº§ -->
                            <Border Grid.Column="3" Classes="score-card">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock
                                        FontSize="24"
                                        FontWeight="Bold"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="{Binding Grade}" />
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="ç­‰çº§" />
                                </StackPanel>
                            </Border>
                        </Grid>
                        
                        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                        <Grid Margin="0,16,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0">
                                <TextBlock Classes="content" Text="å®Œæˆæ—¶é—´:" />
                                <TextBlock Classes="content" Text="{Binding CompletionTime, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1">
                                <TextBlock Classes="content" Text="è®­ç»ƒè€—æ—¶:" />
                                <TextBlock Classes="content" Text="{Binding Duration, StringFormat={}{0:hh\\:mm\\:ss}}" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2">
                                <TextBlock Classes="content" Text="æ­£ç¡®é¢˜ç›®:" />
                                <TextBlock Classes="content" Text="{Binding CorrectQuestions}" Foreground="Green" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="3">
                                <TextBlock Classes="content" Text="é”™è¯¯é¢˜ç›®:" />
                                <TextBlock Classes="content" Text="{Binding IncorrectQuestions}" Foreground="Red" />
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- æ¨¡å—å¾—åˆ†è¯¦æƒ… -->
                <Border Classes="section">
                    <StackPanel>
                        <TextBlock Classes="header" Text="æ¨¡å—å¾—åˆ†è¯¦æƒ…" />
                        <ItemsControl ItemsSource="{Binding ModuleResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="module-item">
                                        <StackPanel>
                                            <!-- åŸºæœ¬ä¿¡æ¯è¡Œ -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Classes="subheader" Text="{Binding ModuleName}" />
                                                    <TextBlock Classes="content" Text="{Binding Details}" TextWrapping="Wrap" />
                                                </StackPanel>

                                                <TextBlock
                                                    Grid.Column="1"
                                                    Classes="content"
                                                    Margin="8,0"
                                                    Text="{Binding AchievedScore, StringFormat={}{0:F1}}" />

                                                <TextBlock
                                                    Grid.Column="2"
                                                    Classes="content"
                                                    Margin="8,0"
                                                    Text="{Binding TotalScore, StringFormat={}/ {0:F1}}" />

                                                <TextBlock
                                                    Grid.Column="3"
                                                    Classes="content"
                                                    Margin="8,0"
                                                    Text="{Binding ScoreRate, StringFormat={}({0:F1}%)}" />
                                            </Grid>

                                            <!-- AIåˆ†æžç»“æžœï¼ˆä»…C#æ¨¡å—æ˜¾ç¤ºï¼‰ -->
                                            <Border IsVisible="{Binding HasAIAnalysis}"
                                                    Background="{DynamicResource SystemFillColorAttentionBackground}"
                                                    CornerRadius="6"
                                                    Padding="12"
                                                    Margin="0,8,0,0">
                                                <StackPanel>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>

                                                        <TextBlock Grid.Column="0"
                                                                   Classes="subheader"
                                                                   Text="ðŸ¤– AIé€»è¾‘æ€§åˆ†æž"
                                                                   Foreground="{DynamicResource SystemFillColorAttention}" />

                                                        <TextBlock Grid.Column="1"
                                                                   Classes="content"
                                                                   Margin="8,0"
                                                                   Text="{Binding AILogicalScore, StringFormat={}è¯„åˆ†: {0}/100}"
                                                                   FontWeight="SemiBold" />

                                                        <TextBlock Grid.Column="2"
                                                                   Classes="content"
                                                                   Margin="8,0"
                                                                   Text="{Binding AIScoreGrade, StringFormat={}({0})}"
                                                                   FontWeight="SemiBold" />
                                                    </Grid>

                                                    <!-- AIæœ€ç»ˆç­”æ¡ˆ -->
                                                    <TextBlock IsVisible="{Binding AIFinalAnswer, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                               Classes="content"
                                                               Text="{Binding AIFinalAnswer, StringFormat={}è¯„ä¼°ç»“è®º: {0}}"
                                                               TextWrapping="Wrap"
                                                               Margin="0,4,0,0" />

                                                    <!-- AIæŽ¨ç†æ­¥éª¤ -->
                                                    <ItemsControl ItemsSource="{Binding AIReasoningSteps}"
                                                                  IsVisible="{Binding AIReasoningSteps.Count, Converter={x:Static conv:IntToBoolConverter.Instance}}"
                                                                  Margin="0,8,0,0">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Classes="content"
                                                                           Text="{Binding FormattedDescription, StringFormat={}â€¢ {0}}"
                                                                           TextWrapping="Wrap"
                                                                           Margin="0,2" />
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>

                                                    <!-- å¤„ç†æ—¶é—´ -->
                                                    <TextBlock Classes="content"
                                                               Text="{Binding AIProcessingTime, StringFormat={}å¤„ç†è€—æ—¶: {0}ms}"
                                                               Foreground="{DynamicResource TextFillColorSecondary}"
                                                               FontSize="11"
                                                               Margin="0,4,0,0" />
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- é¢˜ç›®è¯¦æƒ… -->
                <Border Classes="section">
                    <StackPanel>
                        <TextBlock Classes="header" Text="é¢˜ç›®è¯¦æƒ…" />
                        <ItemsControl ItemsSource="{Binding QuestionResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="question-item">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- çŠ¶æ€å›¾æ ‡ -->
                                            <TextBlock
                                                Grid.Column="0"
                                                FontSize="16"
                                                FontWeight="Bold"
                                                Foreground="{Binding StatusColor}"
                                                Margin="0,0,12,0"
                                                Text="{Binding StatusIcon}"
                                                VerticalAlignment="Center" />
                                            
                                            <!-- é¢˜ç›®ä¿¡æ¯ -->
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Classes="subheader" Text="{Binding QuestionTitle}" />
                                                <TextBlock Classes="content" Text="{Binding ModuleName}" Foreground="{DynamicResource TextFillColorSecondary}" />
                                                <TextBlock Classes="content" Text="{Binding Details}" TextWrapping="Wrap" />
                                            </StackPanel>
                                            
                                            <!-- å¾—åˆ† -->
                                            <StackPanel Grid.Column="2" Margin="8,0">
                                                <TextBlock Classes="content" Text="{Binding AchievedScore, StringFormat={}{0:F1}}" HorizontalAlignment="Right" />
                                                <TextBlock Classes="content" Text="{Binding TotalScore, StringFormat={}/ {0:F1}}" HorizontalAlignment="Right" />
                                            </StackPanel>
                                            
                                            <!-- å¾—åˆ†çŽ‡ -->
                                            <TextBlock
                                                Grid.Column="3"
                                                Classes="content"
                                                Margin="8,0"
                                                Text="{Binding ScoreRate, StringFormat={}{0:F1}%}"
                                                VerticalAlignment="Center" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸ -->
        <StackPanel
            Grid.Row="2"
            Margin="0,20,0,0"
            HorizontalAlignment="Right"
            Orientation="Horizontal"
            Spacing="12">
            <Button
                Padding="20,8"
                Click="ViewDetailsButton_Click"
                Content="æŸ¥çœ‹è¯¦æƒ…" />
            <Button
                Padding="20,8"
                Click="CloseButton_Click"
                Content="å…³é—­" />
        </StackPanel>
    </Grid>
</Window>
