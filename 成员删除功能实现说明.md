# 成员删除功能实现说明

## 功能概述
为两个成员管理页面的成员列表表格添加了删除功能，提供不同的删除策略以满足不同的业务需求。

## 实现的页面

### 1. 非组织成员管理页面
**页面路径**: `https://localhost:7125/AdminMemberWeb`

**删除策略**: 硬删除（完全移除记录）
- 适用于独立的成员记录
- 删除后数据无法恢复
- 适合清理无用或错误的成员数据

### 2. 组织成员详情页面
**页面路径**: `https://localhost:7125/Admin/Organization/Details/{id}`

**删除策略**: 软删除（设置为非活跃状态）
- 保留成员记录和历史数据
- 设置 `IsActive = false`
- 便于数据审计和恢复

## 界面设计

### 按钮布局
```html
<!-- 使用 btn-group 将编辑和删除按钮组合 -->
<div class="btn-group" role="group">
    <!-- 编辑按钮 -->
    <button type="button" class="btn btn-sm btn-outline-primary"
            onclick="showEditMemberModal(...)"
            title="编辑成员信息">
        <i class="bi bi-pencil"></i>
    </button>
    
    <!-- 删除按钮 -->
    <button type="button" class="btn btn-sm btn-outline-danger"
            onclick="deleteMember(...)" 
            title="删除成员">
        <i class="bi bi-trash"></i>
    </button>
</div>
```

### 视觉设计
- **删除按钮样式**: `btn-outline-danger` (红色边框)
- **图标**: `bi-trash` (垃圾桶图标)
- **按钮分组**: 使用 `btn-group` 将编辑和删除按钮组合
- **提示文本**: 明确区分"删除成员"和"从组织中移除"

## JavaScript 实现

### 非组织成员删除
```javascript
async function deleteMember(memberId, memberName) {
    // 确认对话框 - 强调永久性
    if (!confirm(`确定要删除成员"${memberName}"吗？\n\n删除后该成员的所有信息将被永久移除，此操作不可撤销。`)) {
        return;
    }

    try {
        const response = await fetch(`/Admin/Member/DeleteMember/${memberId}`, {
            method: 'DELETE',
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            }
        });

        if (response.ok) {
            showNotification('成员删除成功', 'success');
            setTimeout(() => window.location.reload(), 1000);
        }
    } catch (error) {
        showNotification('删除失败，请稍后重试', 'danger');
    }
}
```

### 组织成员移除
```javascript
async function removeOrganizationMember(memberId, memberName, organizationId) {
    // 确认对话框 - 说明软删除特性
    if (!confirm(`确定要从组织中移除成员"${memberName}"吗？\n\n移除后该成员将不再属于此组织，但成员信息会被保留。`)) {
        return;
    }

    try {
        const response = await fetch(`/Admin/Organization/RemoveMember/${memberId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({ organizationId: organizationId })
        });

        if (response.ok) {
            showNotification('成员移除成功', 'success');
            setTimeout(() => window.location.reload(), 1000);
        }
    } catch (error) {
        showNotification('移除失败，请稍后重试', 'danger');
    }
}
```

## API 端点实现

### 1. 删除非组织成员
```csharp
[HttpDelete]
[Route("Admin/Member/DeleteMember/{memberId}")]
public async Task<IActionResult> DeleteMember(int memberId)
{
    // 查找非组织成员 (OrganizationId == null)
    OrganizationMember? member = await _context.OrganizationMembers
        .FirstOrDefaultAsync(m => m.Id == memberId && m.OrganizationId == null);
    
    if (member == null)
        return NotFound(new { message = "成员不存在" });

    // 硬删除
    _context.OrganizationMembers.Remove(member);
    await _context.SaveChangesAsync();

    // 记录操作日志
    _logger.LogInformation("管理员删除成员成功: 成员ID: {MemberId}, 成员姓名: {RealName}, 操作者: {UserId}",
        memberId, member.RealName, currentUserId);

    return Ok(new { message = $"成员"{member.RealName}"删除成功" });
}
```

### 2. 移除组织成员
```csharp
[HttpDelete]
[Route("Admin/Organization/RemoveMember/{memberId}")]
public async Task<IActionResult> RemoveMember(int memberId, [FromBody] RemoveMemberRequest request)
{
    // 查找组织成员
    OrganizationMember? member = await _context.OrganizationMembers
        .Include(m => m.Organization)
        .FirstOrDefaultAsync(m => m.Id == memberId && m.OrganizationId == request.OrganizationId);
    
    if (member == null)
        return NotFound(new { message = "成员不存在或不属于该组织" });

    // 软删除：设置为非活跃状态
    member.IsActive = false;
    member.UpdatedAt = DateTime.UtcNow;
    member.UpdatedBy = currentUserId;
    await _context.SaveChangesAsync();

    // 记录操作日志
    _logger.LogInformation("管理员从组织中移除成员: 成员ID: {MemberId}, 成员姓名: {RealName}, 组织: {OrganizationName}, 操作者: {UserId}",
        memberId, member.RealName, member.Organization?.Name, currentUserId);

    return Ok(new { message = $"成员"{member.RealName}"已从组织中移除" });
}
```

### 3. 请求模型
```csharp
/// <summary>
/// 移除成员请求模型
/// </summary>
public class RemoveMemberRequest
{
    [Required(ErrorMessage = "组织ID不能为空")]
    public int OrganizationId { get; set; }
}
```

## 安全特性

### 权限控制
- **管理员专用**: 所有删除操作都需要 `AdminPolicy` 权限
- **身份验证**: 验证当前用户身份，记录操作者信息
- **数据验证**: 确保只能删除/移除有权限的成员

### 防误操作
- **确认对话框**: 删除前必须确认操作
- **清晰提示**: 区分永久删除和临时移除
- **操作反馈**: 提供明确的成功/失败反馈

### 审计日志
```csharp
// 详细的操作日志记录
_logger.LogInformation("管理员删除成员成功: 成员ID: {MemberId}, 成员姓名: {RealName}, 操作者: {UserId}",
    memberId, member.RealName, currentUserId);
```

## 数据策略对比

| 方面 | 非组织成员删除 | 组织成员移除 |
|------|---------------|-------------|
| **删除方式** | 硬删除 | 软删除 |
| **数据保留** | 完全移除 | 保留记录 |
| **可恢复性** | 不可恢复 | 可恢复 |
| **适用场景** | 清理错误数据 | 临时移除 |
| **数据库操作** | `Remove()` | `IsActive = false` |
| **历史追踪** | 仅日志记录 | 完整记录保留 |

## 用户体验设计

### 确认对话框文案
**非组织成员删除**:
```
确定要删除成员"张三"吗？

删除后该成员的所有信息将被永久移除，此操作不可撤销。
```

**组织成员移除**:
```
确定要从组织中移除成员"张三"吗？

移除后该成员将不再属于此组织，但成员信息会被保留。
```

### 操作反馈
- **成功提示**: "成员删除成功" / "成员移除成功"
- **失败提示**: "删除失败，请稍后重试" / "移除失败，请稍后重试"
- **自动刷新**: 操作成功后1秒自动刷新页面

## 错误处理

### 前端错误处理
```javascript
try {
    const response = await fetch(url, options);
    if (response.ok) {
        // 成功处理
    } else {
        const errorData = await response.json();
        showNotification(errorData.message || '操作失败', 'danger');
    }
} catch (error) {
    console.error('操作失败:', error);
    showNotification('操作失败，请稍后重试', 'danger');
}
```

### 后端错误处理
```csharp
try {
    // 业务逻辑
    return Ok(new { message = "操作成功" });
}
catch (Exception ex) {
    _logger.LogError(ex, "操作失败: 参数信息");
    return StatusCode(500, new { message = "服务器内部错误" });
}
```

## 测试建议

### 功能测试
- [ ] 删除按钮正确显示
- [ ] 确认对话框正常弹出
- [ ] API调用成功执行
- [ ] 页面正确刷新
- [ ] 数据正确删除/更新

### 权限测试
- [ ] 非管理员无法访问删除功能
- [ ] 跨组织操作被正确阻止
- [ ] 身份验证失败时的处理

### 边界测试
- [ ] 删除不存在的成员
- [ ] 网络异常时的处理
- [ ] 并发删除的处理

## 总结
成功为两个成员管理页面添加了删除功能，采用不同的删除策略满足不同的业务需求。实现了完整的前后端交互、安全控制、错误处理和用户体验优化，为系统的成员管理提供了更加完善的功能支持。
