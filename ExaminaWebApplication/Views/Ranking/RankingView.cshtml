@model ExaminaWebApplication.Models.Ranking.RankingResponseDto
@{
    ViewData["Title"] = Model.TypeName;
    string iconClass = Model.Type switch
    {
        ExaminaWebApplication.Models.Ranking.RankingType.ExamRanking => "bi-trophy-fill text-warning",
        ExaminaWebApplication.Models.Ranking.RankingType.MockExamRanking => "bi-graph-up text-info",
        ExaminaWebApplication.Models.Ranking.RankingType.TrainingRanking => "bi-target text-success",
        _ => "bi-list-ol"
    };
}

<!-- 页面标题 -->
<div class="glass-card glass-card-primary py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 fw-bold mb-0">
                    <i class="@iconClass me-3"></i>
                    @Model.TypeName
                </h1>
                <p class="lead mb-0 mt-2">
                    共 @Model.TotalCount 条记录，当前第 @Model.CurrentPage 页
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-action="Index" class="glass-btn">
                    <i class="bi bi-arrow-left me-2"></i>返回排行榜首页
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Entries.Any())
    {
        <!-- 排行榜表格 -->
        <div class="glass-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" class="text-center" style="width: 80px;">排名</th>
                                <th scope="col">用户信息</th>
                                <th scope="col">考试/训练</th>
                                <th scope="col" class="text-center">得分</th>
                                <th scope="col" class="text-center">用时</th>
                                <th scope="col" class="text-center">完成时间</th>
                                <th scope="col">组织信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in Model.Entries)
                            {
                                <tr>
                                    <td class="text-center">
                                        @if (entry.Rank <= 3)
                                        {
                                            <span class="badge bg-@(entry.Rank == 1 ? "warning" : entry.Rank == 2 ? "secondary" : "dark") fs-6">
                                                @if (entry.Rank == 1)
                                                {
                                                    <i class="bi bi-trophy-fill me-1"></i>
                                                }
                                                else if (entry.Rank == 2)
                                                {
                                                    <i class="bi bi-award-fill me-1"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star-fill me-1"></i>
                                                }
                                                @entry.Rank
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="fs-5 fw-bold">@entry.Rank</span>
                                        }
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@entry.Username</strong>
                                            @if (!string.IsNullOrEmpty(entry.RealName))
                                            {
                                                <br><small class="text-muted">@entry.RealName</small>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@entry.ExamName</strong>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div>
                                            <strong class="text-primary">@entry.Score.ToString("F1")</strong>
                                            @if (entry.MaxScore > 0)
                                            {
                                                <span class="text-muted">/@entry.MaxScore.ToString("F1")</span>
                                            }
                                        </div>
                                        @if (entry.CompletionPercentage > 0)
                                        {
                                            <small class="text-muted">(@entry.CompletionPercentage.ToString("F1")%)</small>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark">@entry.DurationText</span>
                                    </td>
                                    <td class="text-center">
                                        <small>@entry.CompletedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(entry.SchoolName))
                                        {
                                            <div>
                                                <i class="bi bi-building me-1"></i>@entry.SchoolName
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(entry.ClassName))
                                        {
                                            <div>
                                                <i class="bi bi-people me-1"></i>@entry.ClassName
                                            </div>
                                        }
                                        @if (string.IsNullOrEmpty(entry.SchoolName) && string.IsNullOrEmpty(entry.ClassName))
                                        {
                                            <small class="text-muted">未绑定组织</small>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分页导航 -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="排行榜分页" class="mt-4">
                <ul class="pagination justify-content-center">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.CurrentPage - 1)">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    }

                    @{
                        int startPage = Math.Max(1, Model.CurrentPage - 2);
                        int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=1">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="?page=@i">@i</a>
                        </li>
                    }

                    @if (endPage < Model.TotalPages)
                    {
                        @if (endPage < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="?page=@Model.TotalPages">@Model.TotalPages</a>
                        </li>
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.CurrentPage + 1)">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else
    {
        <!-- 空状态 -->
        <div class="glass-card text-center py-5">
            <div class="card-body">
                <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                <h4 class="text-muted">暂无排行榜数据</h4>
                <p class="text-muted">当前还没有完成的考试或训练记录。</p>
                <a asp-action="Index" class="glass-btn glass-btn-primary">
                    <i class="bi bi-arrow-left me-2"></i>返回排行榜首页
                </a>
            </div>
        </div>
    }

    <!-- 页面信息 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="card-body">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        数据生成时间：@Model.GeneratedAt.ToString("yyyy-MM-dd HH:mm:ss")
                        | 显示第 @((Model.CurrentPage - 1) * Model.PageSize + 1) - @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount) 条，共 @Model.TotalCount 条记录
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
