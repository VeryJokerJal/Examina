@model ExaminaWebApplication.Models.ImportedExam.ImportedExam
@{
    ViewData["Title"] = $"考试详情 - {Model.Name}";
}

<!-- 页面标题横幅 -->
<div class="glass-card glass-card-primary py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 fw-bold mb-2">
                    <i class="bi bi-eye me-3"></i>考试详情
                </h1>
                <p class="lead mb-0">@Model.Name</p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-action="ExamList" class="glass-btn me-2">
                    <i class="bi bi-arrow-left me-1"></i>返回列表
                </a>
                <button type="button" class="glass-btn glass-btn-danger"
                        onclick="deleteExam(@Model.Id, '@Model.Name')">
                    <i class="bi bi-trash me-1"></i>删除考试
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 主要内容区域 -->
<div class="container">
    <!-- 考试基本信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>基本信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h3 class="mb-3">@Model.Name</h3>
                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <p class="text-muted mb-3">@Model.Description</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.Tags))
                            {
                                <div class="mb-3">
                                    <strong>标签：</strong>
                                    @foreach (var tag in Model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <span class="badge bg-light text-dark me-1">@tag.Trim()</span>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-md-4">
                            <div class="text-end">
                                <div class="mb-2">
                                    <span class="badge bg-secondary fs-6">@Model.ExamType</span>
                                </div>
                                <div>
                                    @switch (Model.Status)
                                    {
                                        case "Draft":
                                            <span class="badge bg-warning fs-6">草稿</span>
                                            break;
                                        case "Published":
                                            <span class="badge bg-success fs-6">已发布</span>
                                            break;
                                        case "Archived":
                                            <span class="badge bg-secondary fs-6">已归档</span>
                                            break;
                                        default:
                                            <span class="badge bg-light text-dark fs-6">@Model.Status</span>
                                            break;
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 考试设置 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="glass-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>考试设置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="border rounded p-3 text-center">
                                <h4 class="text-primary mb-1">@Model.TotalScore</h4>
                                <small class="text-muted">总分</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-3 text-center">
                                <h4 class="text-info mb-1">@Model.DurationMinutes</h4>
                                <small class="text-muted">时长(分钟)</small>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="border rounded p-3 text-center">
                                <h4 class="text-warning mb-1">@Model.MaxRetakeCount</h4>
                                <small class="text-muted">重考次数</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @(Model.AllowRetake ? "checked" : "") disabled>
                                <label class="form-check-label">允许重考</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @(Model.ShowScore ? "checked" : "") disabled>
                                <label class="form-check-label">显示分数</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @(Model.ShowAnswers ? "checked" : "") disabled>
                                <label class="form-check-label">显示答案</label>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 考试类型设置 -->
                    <div class="row">
                        <div class="col-12">
                            <div class="glass-card glass-card-secondary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1 text-white">
                                                <i class="bi bi-building me-2"></i>考试类型
                                            </h6>
                                            <small class="text-white-50">设置考试的组织级别</small>
                                        </div>
                                        <div>
                                            <div class="btn-group glass-btn-group" role="group" aria-label="考试类型选择">
                                                <input type="radio" class="btn-check" name="examCategory" id="examCategorySchool"
                                                       value="0" @(Model.ExamCategory == ExaminaWebApplication.Models.ImportedExam.ExamCategory.School ? "checked" : "")
                                                       onchange="updateExamCategory(@Model.Id, this.value)">
                                                <label class="glass-btn glass-btn-outline" for="examCategorySchool">学校统考</label>

                                                <input type="radio" class="btn-check" name="examCategory" id="examCategoryProvincial"
                                                       value="1" @(Model.ExamCategory == ExaminaWebApplication.Models.ImportedExam.ExamCategory.Provincial ? "checked" : "")
                                                       onchange="updateExamCategory(@Model.Id, this.value)">
                                                <label class="glass-btn glass-btn-outline" for="examCategoryProvincial">全省统考</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 时间信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock me-2"></i>时间信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>导入时间：</strong><br>
                            <span class="text-muted">@Model.ImportedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
                        </div>
                        <div class="col-md-3">
                            <strong>原始创建时间：</strong><br>
                            <span class="text-muted">@Model.OriginalCreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
                        </div>
                        @if (Model.OriginalUpdatedAt.HasValue)
                        {
                            <div class="col-md-3">
                                <strong>原始更新时间：</strong><br>
                                <span class="text-muted">@Model.OriginalUpdatedAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</span>
                            </div>
                        }
                        @if (Model.OriginalPublishedAt.HasValue)
                        {
                            <div class="col-md-3">
                                <strong>原始发布时间：</strong><br>
                                <span class="text-muted">@Model.OriginalPublishedAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</span>
                            </div>
                        }
                    </div>
                    
                    @if (Model.StartTime.HasValue || Model.EndTime.HasValue)
                    {
                        <hr>
                        <div class="row">
                            @if (Model.StartTime.HasValue)
                            {
                                <div class="col-md-6">
                                    <strong>考试开始时间：</strong><br>
                                    <span class="text-muted">@Model.StartTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </div>
                            }
                            @if (Model.EndTime.HasValue)
                            {
                                <div class="col-md-6">
                                    <strong>考试结束时间：</strong><br>
                                    <span class="text-muted">@Model.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 导入信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-download me-2"></i>导入信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>原始考试ID：</strong><br>
                            <span class="text-muted">@Model.OriginalExamId</span>
                        </div>
                        <div class="col-md-3">
                            <strong>导入文件：</strong><br>
                            <span class="text-muted">@Model.ImportFileName</span>
                        </div>
                        <div class="col-md-3">
                            <strong>文件大小：</strong><br>
                            <span class="text-muted">@((Model.ImportFileSize / 1024.0).ToString("F1")) KB</span>
                        </div>
                        <div class="col-md-3">
                            <strong>导入版本：</strong><br>
                            <span class="text-muted">@Model.ImportVersion</span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>导入状态：</strong>
                            @switch (Model.ImportStatus)
                            {
                                case "Success":
                                    <span class="badge bg-success">导入成功</span>
                                    break;
                                case "Failed":
                                    <span class="badge bg-danger">导入失败</span>
                                    break;
                                default:
                                    <span class="badge bg-warning">@Model.ImportStatus</span>
                                    break;
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(Model.ImportErrorMessage))
                        {
                            <div class="col-md-6">
                                <strong>错误信息：</strong><br>
                                <span class="text-danger">@Model.ImportErrorMessage</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function deleteExam(examId, examName) {
            if (confirm(`确定要删除考试"${examName}"吗？此操作不可撤销。`)) {
                $.ajax({
                    url: '@Url.Action("DeleteExam")',
                    type: 'POST',
                    data: {
                        id: examId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        if (result.success) {
                            window.location.href = '@Url.Action("ExamList")';
                        } else {
                            alert('删除失败: ' + result.message);
                        }
                    },
                    error: function() {
                        alert('删除失败，请稍后重试');
                    }
                });
            }
        }

        function updateExamCategory(examId, categoryValue) {
            // 显示加载状态
            const radioButtons = document.querySelectorAll('input[name="examCategory"]');
            radioButtons.forEach(radio => radio.disabled = true);

            // 创建表单数据
            const formData = new FormData();
            formData.append('id', examId);
            formData.append('examCategory', categoryValue);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            // 发送AJAX请求
            fetch('@Url.Action("UpdateExamCategory")', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功提示
                    showToast('success', data.message);
                } else {
                    // 更新失败，恢复原来的选择
                    const originalValue = categoryValue === '0' ? '1' : '0';
                    document.querySelector(`input[name="examCategory"][value="${originalValue}"]`).checked = true;

                    // 显示错误提示
                    showToast('error', data.message || '更新失败');
                }
            })
            .catch(error => {
                console.error('更新考试类型失败:', error);

                // 恢复原来的选择
                const originalValue = categoryValue === '0' ? '1' : '0';
                document.querySelector(`input[name="examCategory"][value="${originalValue}"]`).checked = true;

                // 显示错误提示
                showToast('error', '网络错误，请稍后重试');
            })
            .finally(() => {
                // 恢复单选按钮可用状态
                radioButtons.forEach(radio => radio.disabled = false);
            });
        }

        function showToast(type, message) {
            // 使用玻璃拟态通知系统
            if (typeof showNotification === 'function') {
                showNotification(message, type);
            } else if (typeof glassNotification !== 'undefined') {
                glassNotification.show(message, type);
            } else {
                // 降级到简单的提示框
                const toast = document.createElement('div');
                toast.className = `glass-notification glass-alert-${type} alert-dismissible fade show position-fixed`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `
                    <div class="glass-notification-content">
                        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="glass-btn-close" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                `;

                document.body.appendChild(toast);

                // 添加显示动画
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                // 添加关闭事件
                const closeBtn = toast.querySelector('.glass-btn-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        toast.classList.add('fade-out');
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 300);
                    });
                }

                // 3秒后自动移除
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.add('fade-out');
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 300);
                    }
                }, 3000);
            }
        }
    </script>
}
