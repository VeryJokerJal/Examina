<?xml version="1.0" encoding="utf-8" ?>
<ContentDialog x:Class="ExamLab.Views.QuestionConfigurationDialog"
               xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
               xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
               xmlns:converters="using:ExamLab.Converters"
               xmlns:models="using:ExamLab.Models"
               Title="题目配置"
               PrimaryButtonText="保存"
               SecondaryButtonText="取消"
               DefaultButton="Primary"
               Style="{StaticResource DefaultContentDialogStyle}">

    <ContentDialog.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
    </ContentDialog.Resources>

    <ScrollViewer MaxHeight="600" VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16" Margin="0,0,0,16">
            <!-- 基本信息 -->
            <Border Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultSolidBrush}" 
                    BorderThickness="1" CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock Text="基本信息" FontSize="16" FontWeight="SemiBold" />
                    
                    <TextBox Header="题目标题" 
                             Text="{Binding Question.Title, Mode=TwoWay}" 
                             PlaceholderText="请输入题目标题" />
                    
                    <TextBox Header="题目内容" 
                             Text="{Binding Question.Content, Mode=TwoWay}" 
                             PlaceholderText="请输入题目内容描述"
                             AcceptsReturn="True" 
                             Height="80" />
                    
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <NumberBox Header="题目排序" 
                                   Value="{Binding Question.Order, Mode=TwoWay}" 
                                   Minimum="1" 
                                   Width="120" />
                        
                        <ToggleSwitch Header="启用题目" 
                                      IsOn="{Binding Question.IsEnabled, Mode=TwoWay}" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- C#题目特殊配置 -->
            <Border Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultSolidBrush}" 
                    BorderThickness="1" CornerRadius="8"
                    Visibility="{Binding IsCSharpModule, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Spacing="12">
                    <TextBlock Text="C#题目配置" FontSize="16" FontWeight="SemiBold" />
                    
                    <ComboBox Header="题目类型" 
                              SelectedItem="{Binding Question.CSharpQuestionType, Mode=TwoWay}"
                              HorizontalAlignment="Stretch">
                        <models:CSharpQuestionType>CodeCompletion</models:CSharpQuestionType>
                        <models:CSharpQuestionType>Debugging</models:CSharpQuestionType>
                        <models:CSharpQuestionType>Implementation</models:CSharpQuestionType>
                    </ComboBox>
                    
                    <TextBox Header="代码文件路径" 
                             Text="{Binding Question.CodeFilePath, Mode=TwoWay}" 
                             PlaceholderText="例如: Program.cs" />
                    
                    <NumberBox Header="直接分数" 
                               Value="{Binding Question.CSharpDirectScore, Mode=TwoWay}" 
                               Minimum="0" 
                               Visibility="{Binding IsDirectScoreType, Converter={StaticResource BoolToVisibilityConverter}}" />
                    
                    <TextBox Header="程序输入参数" 
                             Text="{Binding Question.ProgramInput, Mode=TwoWay}" 
                             PlaceholderText="程序运行时的输入参数（可选）"
                             AcceptsReturn="True" 
                             Height="60" />
                    
                    <TextBox Header="预期输出" 
                             Text="{Binding Question.ExpectedOutput, Mode=TwoWay}" 
                             PlaceholderText="程序预期的控制台输出"
                             AcceptsReturn="True" 
                             Height="80" />
                </StackPanel>
            </Border>

            <!-- 操作点管理 -->
            <Border Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultSolidBrush}" 
                    BorderThickness="1" CornerRadius="8">
                <StackPanel Spacing="12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="操作点配置" FontSize="16" FontWeight="SemiBold" />
                        
                        <Button Grid.Column="1" 
                                Content="添加操作点" 
                                Command="{Binding AddOperationPointCommand}"
                                Style="{ThemeResource AccentButtonStyle}" />
                    </Grid>
                    
                    <!-- 操作点列表 -->
                    <Border Background="{ThemeResource LayerFillColorDefaultBrush}" 
                            CornerRadius="4" 
                            Visibility="{Binding Question.OperationPoints.Count, Converter={StaticResource CountToVisibilityConverter}}">
                        <ListView x:Name="OperationPointListView"
                                  ItemsSource="{Binding Question.OperationPoints}"
                                  SelectedItem="{Binding SelectedOperationPoint, Mode=TwoWay}"
                                  Background="Transparent"
                                  MaxHeight="200">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding Description}" 
                                                       FontSize="12" 
                                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" 
                                                       TextTrimming="CharacterEllipsis" />
                                            <TextBlock FontSize="11" 
                                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                                                <Run Text="分值:" />
                                                <Run Text="{Binding Score}" />
                                                <Run Text="| 排序:" />
                                                <Run Text="{Binding Order}" />
                                            </TextBlock>
                                        </StackPanel>
                                        
                                        <Button Grid.Column="1"
                                                Content="编辑"
                                                Command="{Binding DataContext.EditOperationPointCommand, ElementName=OperationPointListView}"
                                                CommandParameter="{Binding}"
                                                Style="{ThemeResource DefaultButtonStyle}"
                                                Margin="4,0" />

                                        <Button Grid.Column="2"
                                                Content="配置"
                                                Command="{Binding DataContext.ConfigureOperationPointCommand, ElementName=OperationPointListView}"
                                                CommandParameter="{Binding}"
                                                Style="{ThemeResource DefaultButtonStyle}"
                                                Margin="4,0" />

                                        <Button Grid.Column="3"
                                                Content="删除"
                                                Command="{Binding DataContext.DeleteOperationPointCommand, ElementName=OperationPointListView}"
                                                CommandParameter="{Binding}"
                                                Style="{ThemeResource DefaultButtonStyle}"
                                                Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                                Margin="4,0" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Border>
                    
                    <!-- 空状态提示 -->
                    <Border Padding="16" 
                            Background="{ThemeResource LayerFillColorDefaultBrush}" 
                            CornerRadius="4"
                            Visibility="{Binding Question.OperationPoints.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=Zero}">
                        <StackPanel HorizontalAlignment="Center" Spacing="8">
                            <FontIcon FontSize="24" 
                                      Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" 
                                      Glyph="&#xE8A5;" />
                            <TextBlock Text="暂无操作点" 
                                       HorizontalAlignment="Center" 
                                       FontSize="14" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <TextBlock Text="点击上方"添加操作点"按钮开始添加" 
                                       HorizontalAlignment="Center" 
                                       FontSize="12" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- 题目统计信息 -->
            <Border Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultSolidBrush}" 
                    BorderThickness="1" CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock Text="题目统计" FontSize="16" FontWeight="SemiBold" />
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Spacing="4">
                            <TextBlock Text="操作点数量" 
                                       FontSize="12" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <TextBlock Text="{Binding Question.OperationPoints.Count}" 
                                       FontSize="20" 
                                       FontWeight="SemiBold" />
                        </StackPanel>
                        
                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock Text="题目总分" 
                                       FontSize="12" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <TextBlock Text="{Binding Question.TotalScore}" 
                                       FontSize="20" 
                                       FontWeight="SemiBold" />
                        </StackPanel>
                        
                        <StackPanel Grid.Column="2" Spacing="4">
                            <TextBlock Text="创建时间" 
                                       FontSize="12" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <TextBlock Text="{Binding Question.CreatedTime}" 
                                       FontSize="14" 
                                       FontWeight="SemiBold" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</ContentDialog>
